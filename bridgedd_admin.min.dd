<?php
/*
	BridgeDD Admin
	Copyright © 2014 by Dion Designs.
	All Rights Reserved.
*/
if (!defined('BRIDGEDD_ADMIN')) { exit; } if ($phpbb_path) { function no_options_start() { if (!current_user_can('edit_users')) { echo '</table><style type="text/css">#bdd_junk tr, #bdd_junk h3{display:none}#bdd_junk #bdd_role{display:table-row}#bdd_junk table{margin:0}</style><div class="update-nag" style="margin-top:10px"><h3>' . __('Please set all other User options in phpBB.', 'bridgedd') . '</h3></div>'; ob_start(); } } function no_options_end() { if (!current_user_can('edit_users')) { $stuff = ob_get_clean(); $stuff = str_replace(array("\n","\t",'<tr><th><label for="role">'), array('','','<tr id="bdd_role"><th><label for="role">'), $stuff); echo '<div id="bdd_junk">' . $stuff . '</div>'; } echo '<style type="text/css">#password,#password+tr{display:none}</style>'; } function bridgedd_footer($footer) { return $footer .= '<div style="position:absolute;bottom:0;left:0;right:0;font-size:0.9em;text-align:center"><span style="font-family:Georgia,serif">BridgeDD</span> Copyright &copy; 2014 ' . __('by', 'bridgedd') . ' <a href="http://www.dion-designs.com">Dion Designs</a></div>'; } } function bridgedd_admin_init() { register_setting('bridgedd_config', 'bridgedd_config'); } function setup_admin(){ add_options_page('BridgeDD', '<span style="font-family:Georgia,serif;font-size:1.15em">BridgeDD</span>', 'install_plugins', 'bridgedd.php', 'bridgedd_config_page'); } function bridgedd_config_page() { global $db, $bridgedd_config, $config, $wp_cfg_data, $phpbb_path, $phpbb_root_path, $phpbb_user_id, $phpEx; $inst_options = ''; if ($phpbb_path) { $connect_msg = '<div class="wp-editor-container green"><h3>' . sprintf(__('%s has established a connection to phpBB.', 'bridgedd'), '<span class="bdd-serif">BridgeDD</span>') . '</h3></div>'; if ($bridgedd_config['xpost_forum'] != $config['wp_xpforum']) { $sql = 'UPDATE ' . CONFIG_TABLE . " SET config_value = '" . serialize($wp_cfg_data) . "' WHERE config_name = 'wp_bridge'"; $db->sql_query($sql); } if ($bridgedd_config['reg_app'] == 'wp') { $wpreg = ' checked="checked"'; $phpbbreg = ''; if (isset($_GET['settings-updated'])) { update_option('users_can_register', '1'); $sql = 'UPDATE ' . CONFIG_TABLE . " SET config_value = '" . USER_ACTIVATION_DISABLE . "' WHERE config_name = 'require_activation'"; } } else { $wpreg = ''; $phpbbreg = ' checked="checked"'; if (isset($_GET['settings-updated'])) { update_option('users_can_register', '0'); $sql = 'UPDATE ' . CONFIG_TABLE . " SET config_value = '" . $bridgedd_config['phpbb_reg'] . "' WHERE config_name = 'require_activation'"; } } $db->sql_query($sql); @unlink($phpbb_path . 'cache/data_global.php'); } else { $connect_msg = '<div class="wp-editor-container red"><h3>' . __('BridgeDD is not connected to phpBB.', 'bridgedd') . '</h3></div>'; $er = error_reporting(); error_reporting($er & ~E_WARNING & ~E_CORE_WARNING & ~E_USER_WARNING); $path_ary = array(); if (file_exists(SERVER_DOCUMENT_ROOT . '/includes/functions_privmsgs.php')) { $path_ary[] = '/'; } $glob1 = glob(SERVER_DOCUMENT_ROOT . '/*', GLOB_ONLYDIR); if (!empty($glob1)) { foreach ($glob1 as $firstlev) { if (file_exists($firstlev . '/includes/functions_privmsgs.php')) { $path_ary[] = str_replace(SERVER_DOCUMENT_ROOT, '', $firstlev) . '/'; } else { $glob2 = glob($firstlev . '/*', GLOB_ONLYDIR); if (!empty($glob2)) { foreach($glob2 as $secondlev) { if (file_exists($secondlev . '/includes/functions_privmsgs.php')) { $path_ary[] = str_replace(SERVER_DOCUMENT_ROOT, '', $secondlev) . '/'; } else { $glob3 = glob($firstlev . '/*', GLOB_ONLYDIR); if (!empty($glob3)) { foreach(glob($secondlev . '/*', GLOB_ONLYDIR) as $thirdlev) { if (file_exists($thirdlev . '/includes/functions_privmsgs.php')) { $path_ary[] = str_replace(SERVER_DOCUMENT_ROOT, '', $thirdlev) . '/'; } } } } } } } } } error_reporting($er); if (!empty($path_ary)) { foreach($path_ary as $path) { $selected = ''; $html_path = get_option('siteurl') . '/' . BRIDGEDD_DIR . '/bridgedd_check.php?path=' . urlencode($path); if ($phpbb_path && $phpbb_path == SERVER_DOCUMENT_ROOT . $path) { $selected = ' checked="checked"'; } $inst_options .= '<div class="phpbb_path"><input name="bridgedd_config[phpbb_path]" type="radio" value="' . $path . '"' . $selected . ' onclick="get_phpbb_inst(this,\'' . $html_path . '\')" />&nbsp;' . substr($path, 0, -1) . '</div>'; if ($selected) { $inst_options .= '<script type="text/javascript">get_phpbb_inst(document.getElementById(\'phpbb_path\'),\'' . $html_path . '\')</script>'; } } } echo '<script type="text/javascript"> function get_phpbb_inst(elem,path) { var jqxhr = jQuery.get(path, function(data) { var x = document.getElementById("site_check"); x.innerHTML = "<h3 id=\"site_url\">" + data + "</h3><iframe id=\"phpbb_site\" src=\"" + data + "\"></iframe>"; x.style.display = "block"; }) .fail(function() { elem.parentNode.className = "wp-editor-container red dberror"; elem.parentNode.innerHTML = "' . __('Could not connect to phpBB installation', 'bridgedd') . '"; jQuery(elem.parentNode).after("<br />"); }); } </script>'; } echo '<style type="text/css"> .bdd-serif{font-family:Georgia,serif} .green{background-color:#f4fff4!important;border-color:#beb!important} .red{background-color:#fff4f4!important;border-color:#fcc!important} .phpbb_path,.bdd .wp-editor-container.dberror{float:left;clear:both} .bdd .wp-editor-container{display:inline-block;margin:10px 0 10px -10px;padding:0 10px} .bdd .wp-editor-container h3{line-height:1.3em;color:#000} .bdd .wp-editor-container.dberror{margin:3px 0 3px -10px;padding:3px 10px;color:#800;font-weight:bold} .bdd h2{margin-bottom:1em} .bdd form{padding-top:20px;color:#000} .bdd .error,.bdd .updated{margin-left:-10px!important;padding-left:6px!important} .dberror,#site_url{font-family:Arial,Helvetica,sans-serif} .bdd-box{margin-bottom:30px;line-height:1.8em} .bdd-title{margin-bottom:0.5em;font-size:1.2em} #site_check{clear:both} #site_url{margin-bottom:0.5em;font-size:1.2em} #phpbb_site{width:100%;height:320px;border:none} </style> <div class="wrap bdd"><h2>' . sprintf(__('%s Settings', 'bridgedd'), '<span class="bdd-serif">BridgeDD</span>') . '</h2>'; if (version_compare(PHP_VERSION, '5.3.0', '<')) { echo '<div class="wp-editor-container red" style="display:block"><h2 style="margin:0.5em 0">' . __('BridgeDD requires PHP 5.3.0 or later.', 'bridgedd') . '</h2></div>'; } if (!$phpbb_path && !$inst_options) { echo '<div class="wp-editor-container red"><h3>' . __('ERROR: No phpBB installations were found on your server.', 'bridgedd') . '</h3></div>'; } else { echo $connect_msg . '<form method="post" action="options.php">'; if ($phpbb_path) { echo '<div class="bdd-box"> <h3 class="bdd-title">' . __('Application that should handle user registrations:', 'bridgedd') . '</h3> <input type="radio" name="bridgedd_config[reg_app]" value = "wp"' . $wpreg . ' /> WordPress<span style="padding:0 10px"></span> <input type="radio" name="bridgedd_config[reg_app]" value = "phpbb"' . $phpbbreg . ' /> phpBB </div> <input name="bridgedd_config[phpbb_path]" type="hidden" value="' . $bridgedd_config['phpbb_path'] . '" /> <div class="bdd-box"> <h3 class="bdd-title">' . __('Avatar source for BridgeDD widgets:', 'bridgedd') . '</h3> <input type="radio" name="bridgedd_config[avatar_src]" value = "wp"' . (($bridgedd_config[avatar_src] == 'wp') ? ' checked="checked"' : '') . ' /> WordPress<span style="padding:0 10px"></span> <input type="radio" name="bridgedd_config[avatar_src]" value = "phpbb"' . (($bridgedd_config[avatar_src] == 'phpbb') ? ' checked="checked"' : '') . ' /> phpBB </div>'; } else { $phpbb_list = $inst_options . '<div id="site_check"></div>'; echo '<div class="bdd-box"> <span class="bdd-title" style="font-size:1.3em"><strong>' . __('Select a phpBB installation:', 'bridgedd') . '</strong></span> <br /><br /><tt>' . $phpbb_list . '</tt> </div> <input type="hidden" name="bridgedd_config[reg_app]" value="phpbb" /> <input type="hidden" name="bridgedd_config[avatar_src]" value="phpbb" />'; } if (!defined('BRIDGEDD_XPOST')) { $xpost_forum = (isset($bridgedd_config['xpost_forum']) && $bridgedd_config['xpost_forum']) ? $bridgedd_config['xpost_forum'] : 0; $xpost_title = (isset($bridgedd_config['xpost_title']) && $bridgedd_config['xpost_title']) ? esc_attr($bridgedd_config['xpost_title']) : __('The following is an excerpt of a blog article.', 'bridgedd'); $xpost_class = (isset($bridgedd_config['xpost_class']) && $bridgedd_config['xpost_class']) ? esc_attr($bridgedd_config['xpost_class']) : ''; echo '<input type="hidden" name="bridgedd_config[xpost_forum]" value="' . $xpost_forum . '" /> <input type="hidden" name="bridgedd_config[xpost_title]" value="' . $xpost_title . '" /> <input type="hidden" name="bridgedd_config[xpost_class]" value="' . $xpost_class . '" />'; } if (!defined('BRIDGEDD_WPMENU')) { $wpmenu_class = (isset($bridgedd_config['wpmenu_class']) && $bridgedd_config['wpmenu_class']) ? esc_attr($bridgedd_config['wpmenu_class']) : ''; echo '<input type="hidden" name="bridgedd_config[wpmenu_class]" value="' . $wpmenu_class . '" />'; } do_action('bridgedd_addons_config'); echo '<input type="submit" class="button-primary" name="submit" value="' . __('Save Changes', 'bridgedd') . '" /> <input type="hidden" name="bridgedd_config[phpbb_bridge]" value="' . $bridgedd_config['phpbb_bridge'] . '" /> <input type="hidden" name="bridgedd_config[phpbb_reg]" value="' . $bridgedd_config['phpbb_reg'] . '" /> <input type="hidden" name="bridgedd_config[wp_reg]" value="' . $bridgedd_config['wp_reg'] . '" />'; settings_fields('bridgedd_config'); echo '</form>'; } echo '<br /><br /><br /><div class="wp-editor-container"><h3>'; echo __('For support, and free WordPress plugins and phpBB modifications, become a member of our phpBB board:', 'bridgedd') . '<br /><br />'; echo '<a href="http://www.diondesigns.org/bridgedd/support/index.php">http://www.diondesigns.org/bridgedd/support/index.php</a>'; echo '</h3></div>'; echo '</div>'; } function bridgedd_no_update($r) { if (!empty($r['body']['plugins'])) { $r['body']['plugins'] = str_replace('bridgedd\/bridgedd', 'xyzzy', $r['body']['plugins']); } return $r; } function bridgedd_maybe_update($plugin_file, $plugin_data, $status) { $response = wp_remote_get('http://plugins.svn.wordpress.org/bridgedd/tags/public/VERSION'); if (!is_wp_error($response)) { $version = wp_remote_retrieve_body($response); if (!is_wp_error($version) && intval($version) > BRIDGEDD) { $uname = (defined('BRIDGEDD_PRO')) ? ' PRO' : ''; $ulink = (defined('BRIDGEDD_PRO')) ? '<a href="http://www.diondesigns.org/bridgedd/support/viewtopic.php?t=116">http://www.diondesigns.org/bridgedd/support/viewtopic.php?t=116</a>' : '<a href="http://downloads.wordpress.org/plugin/bridgedd.update.zip">http://downloads.wordpress.org/plugin/bridgedd.update.zip</a>'; echo '<tr><td colspan="3" style="padding:0 15px;line-height:2em;background-color:#fff8e8"><h3>' . sprintf(__('%s is available. Click the link to download the update plugin:', 'bridgedd'), '<span style="font-family:Georgia,serif">BridgeDD' . $uname . ' </span>' . str_replace('0', '.', $version)) . '<br />' . $ulink . '</h3></td></tr>'; } } } function add_settings_link($links) { array_unshift($links, '<style type="text/css">#bridgedd .plugin-title strong,#bridgedd-pro .plugin-title strong{font-family:Georgia,serif;font-size:1.25em}#bridgedd .plugin-version-author-uri a,#bridgedd-pro .plugin-version-author-uri a{font-weight:bold}</style><a href="options-general.php?page=bridgedd.php">' . __('Settings', 'bridgedd') . '</a>'); return $links; }
?>
