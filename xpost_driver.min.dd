<?php
/*
	BridgeDD Driver
	Copyright © 2014 by Dion Designs.
	All Rights Reserved.
*/
if (!defined('BRIDGEDD')) { exit; } global $phpbb_path, $phpbb_root_path, $phpEx, $xpost_config, $xcomment_config, $dddb, $dduser, $wpdb; $forum_id = intval($_POST['xpost_forum']); if ($post->post_type != 'post') { return; } if ($new == 'future') { if ($old == 'future') { return; } $sql = 'SELECT forum_id, is_excerpt FROM bridgedd_xpost WHERE wp_id = ' . $post->ID; $result = $dddb->sql_query($sql); $row = $dddb->sql_fetchrow($result); $dddb->sql_freeresult($result); if ($row && $forum_id) { $sql = 'UPDATE bridgedd_xpost SET phpbb_id = 0, topic_id = 0, forum_id = ' . $forum_id . ", is_excerpt = 0, content = '') WHERE wp_id = " . $post->ID; $dddb->sql_query($sql); } else if ($row && !$forum_id) { bridgedd_xpost_delete($post->ID); } else if (!$row && $forum_id) { $sql = 'INSERT INTO bridgedd_xpost (wp_id,phpbb_id,topic_id,forum_id,is_excerpt,content) VALUES (' . $post->ID . ",0,0,$forum_id,0,'')"; $dddb->sql_query($sql); } return; } else if ($new != 'publish') { if ($old == 'future') { bridgedd_xpost_delete($post->ID); } return; } else if ($old == 'future') { $sql = 'SELECT forum_id, is_excerpt FROM bridgedd_xpost WHERE wp_id = ' . $post->ID; $result = $dddb->sql_query($sql); $row = $dddb->sql_fetchrow($result); $dddb->sql_freeresult($result); $forum_id = intval($row['forum_id']); bridgedd_xpost_delete($post->ID); } if ($forum_id) { $wpid = $post->ID; $sql = 'UPDATE ' . $wpdb->posts . " SET comment_status = 'open' , ping_status = 'closed' WHERE ID = $wpid"; $wpdb->query($sql); if (defined('XPOST_EXCERPT_LENGTH')) { $excerpt_length = (intval(XPOST_EXCERPT_LENGTH) < 50) ? 50 : intval(XPOST_EXCERPT_LENGTH); $excerpt_length = ($excerpt_length > 250) ? 250 : $excerpt_length; } else { $excerpt_length = 100; } $subject = htmlspecialchars($post->post_title, ENT_COMPAT, 'UTF-8'); $original_content = str_replace("'", "\'", apply_filters('the_content', $post->post_content)); $is_excerpt = true; if (!empty($post->post_excerpt)) { $content = apply_filters('the_excerpt', str_replace(array("'","\n"), array("\'","\v"), $post->post_excerpt)); } else { $excerpt = array(); $content = apply_filters('the_content', str_replace(array("'","\n"), array("\'","\v"), $post->post_content)); if (preg_match('/<!--more(.*?)?-->/', $content, $matches)) { $excerpt = explode($matches[0], $content, 2); $content = $excerpt[0]; } else { $content = preg_replace('@<(script|style)[^>]*?>.*?</\\1>@si', '', $content); $excerpt = explode(' ', strip_shortcodes(strip_tags($content)), $excerpt_length + 1); $is_excerpt = sizeof($excerpt); if ($is_excerpt == $excerpt_length + 1) { $excerpt[$excerpt_length] = '...'; } else if ($is_excerpt <= $excerpt_length) { $is_excerpt = false; } $content = implode(' ', $excerpt); } unset($excerpt); } $class = ($xpost_config['xpost_class']) ? ' class="' . esc_attr($xpost_config['xpost_class']) . '"' : ''; $title = ($is_excerpt) ? $xpost_config['xpost_title'] . '&nbsp;' : ''; $content = '<div id="bridgedd"> <div class="excerpt-title">' . $title . ' <a' . $class . ' href="' . get_permalink($wpid) . '" target="_blank">' . __('Read Full Article', 'bridgedd') . '</a> </div> <br /> ' . $content . ' </div>'; $content = str_replace(array("\n","\v"), array("\r",'<br />'), $content); $sql = 'SELECT phpbb_id FROM bridgedd_xpost WHERE wp_id = ' . $post->ID; $result = $dddb->sql_query($sql); $xpost_id = $dddb->sql_fetchfield('phpbb_id'); $dddb->sql_freeresult($result); if ($xpost_id) { $sql = 'UPDATE ' . POSTS_TABLE . " SET post_text = '{$dddb->sql_escape($content)}', post_checksum = '{$dddb->sql_escape(md5($content))}' WHERE post_id = $xpost_id"; $dddb->sql_query($sql); $sql = "UPDATE bridgedd_xpost SET content = '{$dddb->sql_escape($original_content)}' WHERE phpbb_id = $xpost_id"; $dddb->sql_query($sql); } else { $sql = 'SELECT u.user_id, u.username FROM ' . USERS_TABLE . ' u, bridgedd_xuser xu WHERE xu.wp_id = ' . $post->post_author . ' AND u.user_id = xu.phpbb_id'; $result = $dddb->sql_query($sql); $row = $dddb->sql_fetchrow($result); $dddb->sql_freeresult($result); if ($row) { $poster_id = (int) $row['user_id']; $username = $row['username']; } else { $poster_id = (int) $dduser->data['user_id']; $username = $dduser->data['username']; } $current_time = time(); $dddb->sql_transaction('begin'); $sql_ary = array( 'forum_id' => $forum_id, 'topic_poster' => $poster_id, 'topic_last_poster_id' => $poster_id, 'topic_time' => $current_time, 'topic_last_post_time' => $current_time, 'topic_last_view_time' => $current_time, 'topic_title' => $subject, 'topic_last_post_subject' => $subject, 'topic_first_poster_name' => $username, 'topic_last_poster_name' => $username, ); if (defined('PHPBB31')) { $sql_ary['topic_visibility'] = $sql_ary['topic_posts_approved'] = 1; } $sql = 'INSERT INTO ' . TOPICS_TABLE . ' ' . $dddb->sql_build_array('INSERT', $sql_ary); $dddb->sql_query($sql); $topic_id = (int) $dddb->sql_nextid(); $sql_ary = array( 'forum_id' => $forum_id, 'topic_id' => $topic_id, 'poster_id' => $poster_id, 'post_time' => $current_time, 'enable_sig' => 0, 'post_subject' => $subject, 'post_text' => $content, 'post_checksum' => md5($content), 'bbcode_uid' => substr(base_convert(substr(md5($config['rand_seed'] . microtime()), 4, 16), 16, 36), 0, BBCODE_UID_LEN), ); if (defined('PHPBB31')) { $sql_ary['post_visibility'] = 1; } $sql = 'INSERT INTO ' . POSTS_TABLE . ' ' . $dddb->sql_build_array('INSERT', $sql_ary); $dddb->sql_query($sql); $post_id = (int) $dddb->sql_nextid(); if ($config['load_db_track']) { $sql_ary = array( 'user_id' => $poster_id, 'topic_id' => $topic_id, 'topic_posted' => 1, ); $dddb->sql_query('INSERT INTO ' . TOPICS_POSTED_TABLE . ' ' . $dddb->sql_build_array('INSERT', $sql_ary)); } if ($config['load_db_lastread']) { $sql_ary = array( 'user_id' => $poster_id, 'forum_id' => $forum_id, 'mark_time' => $current_time, ); $dddb->sql_query('INSERT INTO ' . FORUMS_TRACK_TABLE . ' ' . $dddb->sql_build_array('INSERT', $sql_ary)); $sql_ary['topic_id'] = $topic_id; $dddb->sql_query('INSERT INTO ' . TOPICS_TRACK_TABLE . ' ' . $dddb->sql_build_array('INSERT', $sql_ary)); } $forum_posts = (defined('PHPBB31')) ? 'forum_posts_approved' : 'forum_posts'; $forum_topics_real = (defined('PHPBB31')) ? 'forum_topics_approved' : 'forum_topics_real'; $forum_topics = (defined('PHPBB31')) ? '' : 'forum_topics = forum_topics + 1,'; $sql = 'UPDATE ' . FORUMS_TABLE . " SET $forum_posts = $forum_posts + 1, $forum_topics_real = $forum_topics_real + 1, $forum_topics forum_last_post_id = $post_id, forum_last_post_subject = '" . $dddb->sql_escape($subject) . "', forum_last_post_time = $current_time, forum_last_poster_id = $poster_id, forum_last_poster_name = '" . $dddb->sql_escape($username) . "', forum_last_poster_colour = '' WHERE forum_id = " . $forum_id; $dddb->sql_query($sql); $sql = 'UPDATE ' . TOPICS_TABLE . " SET topic_first_post_id = $post_id, topic_last_post_id = $post_id WHERE topic_id = $topic_id"; $dddb->sql_query($sql); $sql = 'UPDATE ' . USERS_TABLE . " SET user_lastpost_time = $current_time, user_posts = user_posts + 1 WHERE user_id = $poster_id"; $dddb->sql_query($sql); $sql = 'UPDATE ' . CONFIG_TABLE . " SET config_value = config_value + 1 WHERE config_name IN ('num_topics', 'num_posts')"; $dddb->sql_query($sql); $dddb->sql_transaction('commit'); $sql = "INSERT INTO bridgedd_xpost (wp_id,phpbb_id,topic_id,forum_id,is_excerpt,content) VALUES ($wpid,$post_id,$topic_id,$forum_id,0,'$original_content')"; $dddb->sql_query($sql); } }